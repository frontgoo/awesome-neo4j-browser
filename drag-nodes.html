<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Basic sigma.js example</title>
    <style type="text/css">
        body {
            margin: 0;
        }

        #container {
            position: absolute;
            width: 100%;
            height: 100%;
            background: #ccc;
        }
    </style>
</head>
<body>
<div id="container">
    <style>
        #graph-container {
            top: 100px;
            bottom: 30%;
            left: 50px;
            right: 50px;
            position: absolute;
            background: #fff;
            background-color: #455660;
        }

        #sidebar {
            bottom: 0;
            left: 0;
            width: 200px;
            height: 150px;
            position: absolute;
            background-color: #999;
            padding: 10px;
            visibility: hidden;
        }

        #control-pane {
            top: 10px;
            /*bottom: 10px;*/
            right: 10px;
            position: absolute;
            width: 230px;
            /*height: 150px;*/
            background-color: rgb(249, 247, 237);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        #control-pane > div {
            margin: 10px;
            overflow-x: auto;
        }

        .line {
            clear: both;
            display: block;
            width: 100%;
            margin: 0;
            padding: 12px 0 0 0;
            border-bottom: 1px solid #aac789;
            background: transparent;
        }

        h2, h3, h4 {
            padding: 0;
            font-variant: small-caps;
        }

        .green {
            color: #437356;
        }

        h2.underline {
            color: #437356;
            background: #f4f0e4;
            margin: 0;
            border-radius: 2px;
            padding: 8px 12px;
            font-weight: 700;
        }

        .hidden {
            display: none;
            visibility: hidden;
        }

        input[type=range] {
            width: 160px;
        }

        .controls {
            padding: 5px 0;
            text-align: center;
            background: rgba(41, 41, 41, 0.6);
            color: white;
        }

        /*Tool Tip Section*/
        .sigma-tooltip {
            max-width: 240px;
            max-height: 280px;
            background-color: rgb(249, 247, 237);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            border-radius: 6px;
        }

        .sigma-tooltip-header {
            font-variant: small-caps;
            font-size: 120%;
            color: #437356;
            border-bottom: 1px solid #aac789;
            padding: 10px;
        }

        .sigma-tooltip-body {
            padding: 10px;
        }

        .sigma-tooltip-body th {
            color: #999;
            text-align: left;
        }

        .sigma-tooltip-footer {
            padding: 10px;
            border-top: 1px solid #aac789;
        }

        .sigma-tooltip > .arrow {
            border-width: 10px;
            position: absolute;
            display: block;
            width: 0;
            height: 0;
            border-color: transparent;
            border-style: solid;
        }

        .sigma-tooltip.top {
            margin-top: -12px;
        }

        .sigma-tooltip.top > .arrow {
            left: 50%;
            bottom: -10px;
            margin-left: -10px;
            border-top-color: rgb(249, 247, 237);
            border-bottom-width: 0;
        }

        .sigma-tooltip.bottom {
            margin-top: 12px;
        }

        .sigma-tooltip.bottom > .arrow {
            left: 50%;
            top: -10px;
            margin-left: -10px;
            border-bottom-color: rgb(249, 247, 237);
            border-top-width: 0;
        }

        .sigma-tooltip.left {
            margin-left: -12px;
        }

        .sigma-tooltip.left > .arrow {
            top: 50%;
            right: -10px;
            margin-top: -10px;
            border-left-color: rgb(249, 247, 237);
            border-right-width: 0;
        }

        .sigma-tooltip.right {
            margin-left: 12px;
        }

        .sigma-tooltip.right > .arrow {
            top: 50%;
            left: -10px;
            margin-top: -10px;
            border-right-color: rgb(249, 247, 237);
            border-left-width: 0;
        }

        #container-query{
            position: absolute;
            bottom: 0;
            left: 0;
            right:0;
            width: 100%;
            height: 50px;
        }
        #query{
            position: absolute;
            bottom: 0;
            left: 0;
            width: 90%;
            height: 100%;
        }
        #query-btn{
            position: absolute;
            right: 0;
            bottom: 50px;
        }

    </style>
    <header class="controls">Activate / Deactivate Lasso with Alt + L</header>
    <div id="graph-container"></div>
    <div id="control-pane">
        <h2 class="underline">filters</h2>

        <div>
            <h3>min degree <span id="min-degree-val">0</span></h3>
            0 <input id="min-degree" type="range" min="0" max="0" value="0"> <span id="max-degree-value">0</span><br>
        </div>
        <div>
            <h3>node category</h3>
            <select id="node-category">
                <option value="" selected>All categories</option>
            </select>
        </div>

        <div>
            <h3>Node list</h3>
            <select id="node-list">
                <option value="" selected>All Nodes</option>
            </select>
        </div>
        <h2 class="underline">Change Type</h2>

        <div>
            <h3>Edge Types</h3>
            <select id="edge-type">
                <option value="arrow" selected>arrow</option>
                <option value="line" select>line</option>
                <option value="curve" select>curve</option>
                <option value="curvedArrow" select>curvedArrow</option>
                <option value="dashed" select>dashed</option>
                <option value="dotted" select>dotted</option>
                <option value="parallel" select>parallel</option>
                <option value="tapered" select>tapered</option>
            </select>
        </div>

        <div>
            <h3>Node Types</h3>
            <select id="node-type">
                <option value="square" selected>square</option>
                <option value="circle" select>circle</option>
                <option value="diamond" select>diamond</option>
                <option value="cross" select>cross</option>
                <option value="equilateral" select>equilateral</option>
                <option value="star" select>star</option>
                <option value="pacman" select>pacman</option>
            </select>
        </div>
        <h2 class="underline">Locate</h2>

        <div>
            <h3>a node</h3>
            <select id="locate-node-list">
                <option value="" selected>All nodes</option>
            </select>
        </div>
        <div>
            <h3>a group of nodes</h3>
            <select id="locate-node-category">
                <option value="" selected>All groups</option>
            </select>
        </div>
        <span class="line"></span>

        <div>
            <button id="locate-reset-btn">Reset view</button>
        </div>

        <span class="line"></span>

        <div>
            <button id="filter-reset-btn">Reset filters</button>
            <button id="download-btn">Export JPG</button>
            <button id="export-svg-btn">Export SVG</button>
        </div>
        <div id="dump" class="hidden"></div>

    </div>

    <div id="container-query">
        <textarea id="query">AAA</textarea>
        <button id="query-btn">Query</button>
    </div>
    <div id="sidebar">This area is not a drop target.

    </div>

</div>
<!--导入Sigma源文件-->
<script src="../sigma.js/build/sigma.min.js"></script>

<!-- use Linkurious js -->
<!--<script src="../Linkurious/linkurious.js/build/sigma.js"></script>-->


<!--<script src="../Linkurious/linkurious.js/plugins/sigma.renderers.linkurious/settings.js"></script>-->
<!--<script src="../Linkurious/linkurious.js/plugins/sigma.renderers.linkurious/webgl/sigma.webgl.nodes.def.js"></script>-->
<!--<script src="../Linkurious/linkurious.js/plugins/sigma.renderers.linkurious/webgl/sigma.webgl.nodes.fast.js"></script>-->
<!--<script src="../Linkurious/linkurious.js/plugins/sigma.renderers.linkurious/webgl/sigma.webgl.edges.def.js"></script>-->
<!--<script src="../Linkurious/linkurious.js/plugins/sigma.renderers.linkurious/webgl/sigma.webgl.edges.fast.js"></script>-->
<!--<script src="../Linkurious/linkurious.js/plugins/sigma.renderers.linkurious/webgl/sigma.webgl.edges.arrow.js"></script>-->
<!--<script src="../Linkurious/linkurious.js/plugins/sigma.renderers.linkurious/canvas/sigma.canvas.labels.def.js"></script>-->
<!--<script src="../Linkurious/linkurious.js/plugins/sigma.renderers.linkurious/canvas/sigma.canvas.hovers.def.js"></script>-->
<!--<script src="../Linkurious/linkurious.js/plugins/sigma.renderers.linkurious/canvas/sigma.canvas.nodes.def.js"></script>-->
<!--<script src="../Linkurious/linkurious.js/plugins/sigma.renderers.linkurious/canvas/sigma.canvas.edges.def.js"></script>-->
<!--<script src="../Linkurious/linkurious.js/plugins/sigma.renderers.linkurious/canvas/sigma.canvas.edges.curve.js"></script>-->
<!--<script src="../Linkurious/linkurious.js/plugins/sigma.renderers.linkurious/canvas/sigma.canvas.edges.arrow.js"></script>-->
<!--<script src="../Linkurious/linkurious.js/plugins/sigma.renderers.linkurious/canvas/sigma.canvas.edges.curvedArrow.js"></script>-->
<!--<script src="../Linkurious/linkurious.js/plugins/sigma.renderers.linkurious/canvas/sigma.canvas.edgehovers.def.js"></script>-->
<!--<script src="../Linkurious/linkurious.js/plugins/sigma.renderers.linkurious/canvas/sigma.canvas.edgehovers.arrow.js"></script>-->
<!--<script src="../Linkurious/linkurious.js/plugins/sigma.renderers.linkurious/canvas/sigma.canvas.edgehovers.curve.js"></script>-->
<!--<script src="../Linkurious/linkurious.js/plugins/sigma.renderers.linkurious/canvas/sigma.canvas.edgehovers.curvedArrow.js"></script>-->


<!--导入拖拽节点-->
<script src="../sigma.js/plugins/sigma.plugins.dragNodes/sigma.plugins.dragNodes.js"></script>

<!--导入ForceAtlas 布局-->
<script src="../sigma.js/plugins/sigma.layout.forceAtlas2/worker.js"></script>
<script src="../sigma.js/plugins/sigma.layout.forceAtlas2/supervisor.js"></script>
<!---->

<!--给边加标签-->
<script src="../sigma.js/plugins/sigma.renderers.edgeLabels/settings.js"></script>
<script src="../sigma.js/plugins/sigma.renderers.edgeLabels/sigma.canvas.edges.labels.def.js"></script>
<script src="../sigma.js/plugins/sigma.renderers.edgeLabels/sigma.canvas.edges.labels.curve.js"></script>
<script src="../sigma.js/plugins/sigma.renderers.edgeLabels/sigma.canvas.edges.labels.curvedArrow.js"></script>

<!--边过滤器-->
<script src="../sigma.js/plugins/sigma.plugins.filter/sigma.plugins.filter.js"></script>

<!--Noverlap 布局-->
<script src="../sigma.js/plugins/sigma.plugins.animate/sigma.plugins.animate.js"></script>
<script src="../sigma.js/plugins/sigma.layout.noverlap/sigma.layout.noverlap.js"></script>
<!-- 自定义边形状的插件 -->
<script src="../sigma.js/plugins/sigma.renderers.customEdgeShapes/sigma.canvas.edges.dashed.js"></script>
<script src="../sigma.js/plugins/sigma.renderers.customEdgeShapes/sigma.canvas.edges.dotted.js"></script>
<script src="../sigma.js/plugins/sigma.renderers.customEdgeShapes/sigma.canvas.edges.parallel.js"></script>
<script src="../sigma.js/plugins/sigma.renderers.customEdgeShapes/sigma.canvas.edges.tapered.js"></script>
<script src="../sigma.js/plugins/sigma.renderers.customEdgeShapes/sigma.canvas.edgehovers.dashed.js"></script>
<script src="../sigma.js/plugins/sigma.renderers.customEdgeShapes/sigma.canvas.edgehovers.dotted.js"></script>
<script src="../sigma.js/plugins/sigma.renderers.customEdgeShapes/sigma.canvas.edgehovers.parallel.js"></script>
<script src="../sigma.js/plugins/sigma.renderers.customEdgeShapes/sigma.canvas.edgehovers.tapered.js"></script>

<!-- 自定义节点形状的插件 -->
<script src="../sigma.js/plugins/sigma.renderers.customShapes/shape-library.js"></script>
<script src="../sigma.js/plugins/sigma.renderers.customShapes/sigma.renderers.customShapes.js"></script>

<!-- 保存成图片-->

<script src="../Linkurious/linkurious.js/plugins/sigma.exporters.image/sigma.exporters.image.js"></script>
<!-- 保存SVG -->
<script src="../Linkurious/linkurious.js/plugins/sigma.exporters.svg/sigma.exporters.svg.js"></script>

<!-- 实现SVG free style -->
<!-- 很多插件在SVG 下不能用，故不使用SVG -->
<!--<script src="../sigma.js/plugins/sigma.plugins.neighborhoods/sigma.plugins.neighborhoods.js"></script>-->
<!--<script src="../sigma.js/examples/lib/jquery-2.1.1.min.js"></script>-->
<!--<script src="../Linkurious/linkurious.js/plugins/sigma.layouts.dagre/sigma.layout.dagre.js"></script>-->


<!-- Locate -->
<script src="../Linkurious/linkurious.js/plugins/sigma.plugins.locate/sigma.plugins.locate.js"></script>

<!-- 选中画笔 -->

<script src="../Linkurious/linkurious.js/plugins/sigma.plugins.lasso/sigma.plugins.lasso.js"></script>

<!-- Tooltips -->
<script src="../Linkurious/linkurious.js/plugins/sigma.plugins.tooltips/sigma.plugins.tooltips.js"></script>
<script src="js/mustache.min.js"></script>

<!-- 图例 -->
<script src="../Linkurious/linkurious.js/plugins/sigma.plugins.design/sigma.plugins.design.js"></script>
<script src="../Linkurious/linkurious.js/plugins/sigma.plugins.legend/settings.js"></script>
<script src="../Linkurious/linkurious.js/plugins/sigma.plugins.legend/sigma.plugins.legend.js"></script>


<!-- 增加CYPHER -->
<script src="../sigma.js/plugins/sigma.parsers.json/sigma.parsers.json.js"></script>
<script src="../sigma.js/plugins/sigma.neo4j.cypher/sigma.neo4j.cypher.js"></script>


<!-- 我写的JS -->
<script src="js/utils.js"></script>

<script>
    var awesome_settings = {};
    awesome_settings.doubleClickEnabled = false;
    var enable_hover_edge = true;
    var enable_drag_node = true;
    var enable_hover_node = true;
    //hover edge
    if (enable_hover_edge) {

        awesome_settings.enableEdgeHovering = true;
        awesome_settings.edgeHoverColor = "edge";
        awesome_settings.defaultEdgeHoverColor = '#000';
        awesome_settings.edgeHoverSizeRatio = 2;
        awesome_settings.edgeHoverExtremities = true;

        //min max size
        awesome_settings.minNodeSize = 1;
        awesome_settings.maxNodeSize = 10;
        awesome_settings.minEdgeSize = 1;
        awesome_settings.maxEdgeSize = 5;

        //LABLE
//        awesome_settings.edgeLabelSize = 'proportional';
    }

    if (enable_hover_node) {
        awesome_settings.enableHovering = true;
        awesome_settings.borderSize = 5;
        awesome_settings.defaultNodeBorderColor = "#00F";


    }
    awesome_settings.nodesPowRatio = 1;
    awesome_settings.edgesPowRatio = 1;
    /**
     * This example shows how to use the dragNodes plugin.
     */
    var i,
            s,
            N = 20,
            E = 100,
            g = {
                nodes: [],
                edges: []
            };


    // Instantiate sigma:
    s = new sigma({
        graph: g,
        renderer: {
            container: document.getElementById('graph-container'),
            type: 'canvas'
        },
        settings: awesome_settings
    });

    /**
     *
     * 启用拖拽节点效果插件
     *
     */
    enableDraggable();
    var filter = enableFilter();
    enableLocate();
    enableChangeEdgeType();
    enableChangeNodeType();
    enableExportSvg();
    enableExportImage();
    enableLasso();
    enableTooltip();
    enableLegend();
    enableNeoQuery();


    //启用事件追踪

    enableEventTracker();

//    queryCypher();


    function initData(s) {
        var nodes_list = s.graph.nodes();
        var edege_list = s.graph.edges();
        g.nodes = nodes_list;
        g.edges = edege_list;

        for (i = 0; i < nodes_list.length; i++) {
            var node = nodes_list[i];
            node.x = Math.random();
            node.y = Math.random();
            node.size = 5;
            node.color = "#666";
            node.category = ['A', 'B', 'C', 'D'][Math.random() * 4 | 0];
            node.data = {
                name: 'Jean',
                gender: 'Male',
                age: 28,
                city: 'Paris'
            };
        }

        for (i = 0; i < edege_list.length; i++) {
            var edge = edege_list[i];
            edge.size = 5;
            edge.color = "#CCC";
            edge.hover_color = "#000";
            edge.type = "arrow";
        }
        updatePane(s.graph);

        s.refresh();
//        enableForceAtlas();
        enableNoverLap();
//        setTimeout("enableNoverLap()", 3000);


    }

    function updatePane(graph) {
        // get max degree
        var maxDegree = 0,
                categories = {},
                id_list = {};

        // read nodes
        graph.nodes().forEach(function (n) {
            maxDegree = Math.max(maxDegree, graph.degree(n.id));
            categories[n.category] = true;
            id_list[n.id] = true;
        });

        // min degree
        __.$('min-degree').max = maxDegree;
        __.$('max-degree-value').textContent = maxDegree;

        function initSelect(id, defaultText, defaultValue){
            var selectElt = __.$(id);
            selectElt.innerHTML = "";
            var defaultOpt = document.createElement("option");
            defaultOpt.value = defaultValue;
            defaultOpt.text = defaultText;
            selectElt.add(defaultOpt);
            selectElt.selectedIndex = 0;
        }

        // node category
        initSelect("node-category", "All CATEGORIES", "");
        var nodecategoryElt = __.$('node-category');
        Object.keys(categories).forEach(function (c) {
            var optionElt = document.createElement("option");
            optionElt.text = c;
            nodecategoryElt.add(optionElt);
        });

        // node list
        initSelect("node-list", "All NODES", "");
        var nodelistElt = __.$('node-list');
        Object.keys(id_list).forEach(function (c) {
            var optionElt = document.createElement("option");
            optionElt.text = c;
            nodelistElt.add(optionElt);
        });


        // node category
        initSelect("locate-node-category", "All CATEGORIES", "");
        var nodecategoryElt = __.$('locate-node-category');
        Object.keys(categories).forEach(function (c) {
            var optionElt = document.createElement("option");
            optionElt.text = c;
            nodecategoryElt.add(optionElt);
        });

        // node list
        initSelect("locate-node-list", "All NODES", "");
        var nodelistElt = __.$('locate-node-list');
        Object.keys(id_list).forEach(function (c) {
            var optionElt = document.createElement("option");
            optionElt.text = c;
            nodelistElt.add(optionElt);
        });
    }
    function enableNeoQuery(){
        __.$("query").value = "MATCH (n) OPTIONAL MATCH (n)-[r]->(m) RETURN n,r,m LIMIT 10";
        __.$("query-btn").addEventListener("click", function(e){
            var statement = __.$("query").value;
            console.log(statement);
            queryCypher(statement);
        });
    }
    function queryCypher(sql) {
        sigma.neo4j.cypher(
                {url: 'http://localhost:7474', user: 'neo4j', password: '32jsyu'},
                sql,
                s,
                function (s) {
                    console.log('Number of nodes :' + s.graph.nodes().length);
                    console.log('Number of edges :' + s.graph.edges().length);
                    initData(s);
                }
        );
    }

    function getNeoAllTypes() {
        // Calling neo4j to get all its relationship type
        sigma.neo4j.getTypes(
                {url: 'http://localhost:7474', user: 'neo4j', password: '32jsyu'},
                function (types) {
                    console.log("Relationship types" + types);
                }
        );

    }
    function getNeoAllLabels() {
        // Calling neo4j to get all its node label
        sigma.neo4j.getLabels(
                {url: 'http://localhost:7474', user: 'neo4j', password: '32jsyu'},
                function (labels) {
                    console.log("Node labels" + labels);
                }
        );

    }

    function enableDraggable() {
        dragListener = sigma.plugins.dragNodes(s, s.renderers[0]);
        dragListener.bind('startdrag', function (event) {
        });
        dragListener.bind('drag', function (event) {
        });
        dragListener.bind('drop', function (event) {
        });
        dragListener.bind('dragend', function (event) {
        });
        return dragListener;
    }
    ;

    function enableEventTracker() {
        s.bind('clickNode', function (e) {
//            console.log(e.type, e.data.node.label, e.data.captor);
//            filter.undo().neighborsOf(e.data.node.id).apply();
        });
        s.bind('clickStage', function (e) {
//            console.log(e.type, e.data.captor);
            filter.undo().apply();
        });
        s.bind('overNode outNode clickNode doubleClickNode rightClickNode', function (e) {
            //        console.log(e.type, e.data.node.label, e.data.captor);
        });
        s.bind('overEdge outEdge clickEdge doubleClickEdge rightClickEdge', function (e) {
            //        console.log(e.type, e.data.edge, e.data.captor);
        });
        s.bind('clickStage', function (e) {
            //        console.log(e.type, e.data.captor);
        });
        s.bind('doubleClickStage rightClickStage', function (e) {
            //        console.log(e.type, e.data.captor);
        });

    }
    ;


    /**
     * 使用Noverlap 布局,保证不OVERLAP和保持Marigin的算法
     *
     */
    function enableNoverLap() {
        var config = {
            nodeMargin: 3.0,
            scaleNodes: 1.3
        };
        // Configure the algorithm
        var listener = s.configNoverlap(config);

        // Bind all events:
        listener.bind('start stop interpolate', function (event) {
            console.log(event.type);
        });
        // Start the algorithm:
        s.startNoverlap();

    }


    /**
     * 使用Force ATlas2布局
     *
     */
    function enableForceAtlas() {
        s.startForceAtlas2({worker: true, barnesHutOptimize: false});
        console.log("startForceAtlas");
        console.log(new Date().toLocaleTimeString());


        this.stopForceAtlas = function () {
            console.log("stopForceAtlas");
            console.log(new Date().toLocaleTimeString());
            s.stopForceAtlas2();
        }
        //5秒后停止Force Atlas
        setTimeout("this.stopForceAtlas()", 2000);
        console.log(new Date().toLocaleTimeString());

    }

    function enableFilter() {
        var filter = new sigma.plugins.filter(s);

        // reset filter button
        __.$('filter-reset-btn').addEventListener("click", function (e) {
            __.$('min-degree').value = 0;
            __.$('min-degree-val').textContent = '0';
            __.$('node-category').selectedIndex = 0;
            filter.undo().apply();
//            __.$('dump').textContent = '';
//            __.hide('#dump');
        });

        function applyMinDegreeFilter(e) {
            var v = e.target.value;
            __.$('min-degree-val').textContent = v;

            filter
                    .undo('min-degree')
                    .nodesBy(function (n) {
                        //定义的过滤数据的方法，只显示度大于V的
                        return this.degree(n.id) >= v;
                    }, 'min-degree')
                //min-degree is filter name, 被用作去undo
                    .apply();
        }

        function applyCategoryFilter(e) {
            var c = e.target[e.target.selectedIndex].value;
            if (c == "") {
                filter.undo().apply();
                return;
            }
            filter
                    .undo('node-category')
                    .nodesBy(function (n) {
                        //定义过滤数据的方法，如果C的MAP为0，直接返回
                        //否则判断Node的category属性是否为C，是的话 保留Return
                        return !c.length || n.category === c;
                    }, 'node-category')
                //node-category is filter name, 被用作去undo
                    .apply();
        }

        function applyNodeFilter(e) {
            var node = e.target[e.target.selectedIndex].value;

            if (node == "") {
                filter.undo().apply();
                return;
            }
            filter.undo().neighborsOf(node).apply();
        }

        __.$('min-degree').addEventListener("input", applyMinDegreeFilter);  // for Chrome and FF
        __.$('min-degree').addEventListener("change", applyMinDegreeFilter); // for IE10+, that sucks
        __.$('node-category').addEventListener("change", applyCategoryFilter);
        __.$('node-list').addEventListener("change", applyNodeFilter);


        return filter;
    }

    function enableLocate() {
        /**
         * Locate
         *
         *
         */

        var locate_conf = {
            animation: {
                node: {
                    duration: 800
                },
                edge: {
                    duration: 800
                },
                center: {
                    duration: 300
                }
            },
            focusOut: true,
            zoomDef: 1
        };
        var locate = sigma.plugins.locate(s, locate_conf);

        locate.setPadding({
            // top:250,
            // bottom: 250,
            right: 250,
            // left:250
        });

        if (!s.settings('autoRescale')) {
            sigma.utils.zoomTo(s.camera, 0, 0, locate_conf.zoomDef);
        }

        function locateNode(e) {
            var nid = e.target[e.target.selectedIndex].value;
            if (nid == '') {
                locate.center(1);
            }
            else {
                locate.nodes(nid);
            }
        };

        function locateNodesByCategory(e) {
            var c = e.target[e.target.selectedIndex].value;
            if (c == '') {
                locate.center(1);
            }
            else {
                var nodes = s.graph.nodes().filter(function (n) {
                    return n.category == c;
                }).map(function (n) {
                    return n.id;
                });

                locate.nodes(nodes);
            }
        };

        __.$('locate-node-list').addEventListener("change", locateNode);
        __.$('locate-node-category').addEventListener("change", locateNodesByCategory);

        // reset button
        __.$('locate-reset-btn').addEventListener("click", function (e) {
            __.$('locate-node-list').selectedIndex = 0;
            __.$('locate-node-category').selectedIndex = 0;
            locate.center(locate_conf.zoomDef);
        });
        return locate;
    }


    function enableChangeEdgeType() {
        /**
         * 修改边类型
         * @param e
         */
        function changeEdgeType(e) {
            var edge_type = e.target[e.target.selectedIndex].value;
            s.graph.edges().forEach(function (e) {
                e.type = edge_type;
            });
            s.refresh();
        }
        __.$('edge-type').addEventListener("change", changeEdgeType);
    }

    function enableChangeNodeType() {
        /**
         * 增加 修改 节点类型
         * @param e
         */
        var urls = [
            'img/img1.png',
            'img/img2.png',
            'img/img3.png',
            'img/img4.png'
        ];

        function changeNodeType(e) {
            var node_type = e.target[e.target.selectedIndex].value;
            s.graph.nodes().forEach(function (node) {
                node.type = node_type;
                // Insert Image
                if (Math.random() > 0.75 && node.type != 'pacman') { // ~0.75 of the (non-pacman)shapes will have an image
                    node.image = {
                        url: urls[Math.floor(Math.random() * urls.length)],
                        // scale/clip are ratio values applied on top of 'size'
                        scale: 1.3,
                        clip: 0.85
                    }
                }

                // Setting according to types

                switch (node.type) {
                    case "equilateral":
                        node.equilateral = {
                            rotate: Math.random() * 45, // random rotate up to 45 deg
                            numPoints: Math.round(5 + Math.random() * 3)
                        };
                        break;
                    case "star":
                        node.star = {
                            innerRatio: 0.4 + Math.random() * 0.2,
                            numPoints: Math.round(4 + Math.random() * 3)
                        };
                        if (node.image) {
                            // note clip/scale are ratio values. So we fit them to the inner ratio of the star shape
                            node.image.clip = node.star.innerRatio * 0.95;
                            node.image.scale = node.star.innerRatio * 1.2;
                        }
                        break;
                    case "square":
                    case "diamond":
                        if (node.image) {
                            // note clip/scale are ratio values. So we fit them to the borders of the square shape
                            node.image.clip = 0.7;
                        }
                        break;
                    case "circle":
                        break;
                    case "cross":
                        node.cross = {
                            lineWeight: Math.round(Math.random() * 5)
                        };
                        break;
                }

            });
            CustomShapes.init(s);
            s.refresh();
        }
        __.$('node-type').addEventListener("change", changeNodeType);

    }

    function enableExportImage(){
        /**
         * 保存图片
         *
         */
        function generateImage(mouse, clip) {
            var size = 3000;
            var color = "#FFFFFF";
            sigma.plugins.image(s, s.renderers[0], {
                download: true,
                size: size,
                margin: 50,
                background: color,
                clip: clip,
                zoomRatio: 1,
                labels: true,
                format: 'jpg'
            });
        }
        __.$('download-btn').addEventListener("click", generateImage);
    }
    function enableExportSvg(){
        /**
         * 保存成SVG
         */
        function generateSvg() {
            console.log("Export to SVG");
            s.toSVG(
                    {
                        download: true,
                        filename: 'mygraph.svg',
                        size: 1000,
                        data: true,
                        labels: true,
                    });
        }
        __.$('export-svg-btn').addEventListener("click", generateSvg);
    }
    function enableLasso(){
        /**
         *
         * Lasso Section
         *
         */
        var nodeRadius = 50;
        var initializeGraph = function (sigmaInstance) {

            var lasso = new sigma.plugins.lasso(sigmaInstance, sigmaInstance.renderers[0], {
                'strokeStyle': 'black',
                'lineWidth': 2,
                'fillWhileDrawing': true,
                'fillStyle': 'rgba(41, 41, 41, 0.2)',
                'cursor': 'crosshair'
            });

            // Listen for selectedNodes event
            lasso.bind('selectedNodes', function (event) {
                // Do something with the selected nodes
                var nodes = event.data;

                console.log('nodes', nodes);

                // For instance, reset all node size as their initial size
                sigmaInstance.graph.nodes().forEach(function (node) {
                    node.color = 'black';
                    node.size = nodeRadius;
                });

                // Then increase the size of selected nodes...
                nodes.forEach(function (node) {
                    node.color = 'rgb(42, 187, 155)';
                    node.size *= 3;
                });

                sigmaInstance.refresh();
            });

            return lasso;
        };
        var firstLasso = initializeGraph(s);

        document.addEventListener('keyup', function (event) {
            switch (event.keyCode) {
                case 76:
                    if (event.altKey) {
                        if (firstLasso.isActive) {
                            firstLasso.deactivate();
                        } else {
                            firstLasso.activate();
                        }
                    }
                    break;
            }
        });
    }
    function enableTooltip(){
        /**
         * 增加Tooltip
         */
        var config = {
            node: [{
                show: 'overNode',
                hide: 'outNode',
                cssClass: 'sigma-tooltip',
                position: 'top',
                //autoadjust: true,
                template: '<div class="arrow"></div>' +
                ' <div class="sigma-tooltip-header">{{label}}</div>' +
                '  <div class="sigma-tooltip-body">' +
                '    <table id = "tooltip-table">' +
                '      <content></content>' +
                '    </table>' +
                '  </div>' +
                '  <div class="sigma-tooltip-footer">Number of connections: {{degree}}</div>',
                renderer: function (node, template) {
                    // The function context is s.graph
                    node.degree = this.degree(node.id);
                    var content = "";
                    Object.keys(node.neo4j_data).forEach(function(key){
                        content += "<tr><th>key</th> <td>value</td></tr>".replace('key', key).replace('value', node.neo4j_data[key]);
                    });
                    template = template.replace('<content></content>', content);

                    // Returns an HTML string:
                    return Mustache.render(template, node);

                    // Returns a DOM Element:
                    //var el = document.createElement('div');
                    //return el.innerHTML = Mustache.render(template, node);
                }
            }, {
                show: 'rightClickNode',
                cssClass: 'sigma-tooltip',
                position: 'right',
                template: '<div class="arrow"></div>' +
                ' <div class="sigma-tooltip-header">{{label}}</div>' +
                '  <div class="sigma-tooltip-body">' +
                '   <p> Context menu for {{data.name}} </p>' +
                '  </div>' +
                ' <div class="sigma-tooltip-footer">Number of connections: {{degree}}</div>',
                renderer: function (node, template) {
                    node.degree = this.degree(node.id);
                    return Mustache.render(template, node);
                }
            }],
            stage: {
                template: '<div class="arrow"></div>' +
                '<div class="sigma-tooltip-header"> Menu </div>'
            }
        };

        // Instanciate the tooltips plugin with a Mustache renderer for node tooltips:
        var tooltips = sigma.plugins.tooltips(s, s.renderers[0], config);
        tooltips.bind('shown', function(event) {
//        console.log('tooltip shown', event);
        });

        tooltips.bind('hidden', function(event) {
//        console.log('tooltip hidden', event);
        });

    }
    function enableLegend(){
        /**
         * 图例, 必须与Design捆绑使用，否则不显示
         */

        /* Initialize the legend and display all the widgets that have a mapping */
        var legend = sigma.plugins.legend(s);
        //    legend.addWidget('node', 'color', '$');
        //    legend.getWidget('node', 'size').setUnit('$'); // Add '($)' to the widget representing the node size
        legend.setPlacement('left'); // Position the legend on the left (default: bottom)
        legend.addTextWidget('This is an example legend'); // Add a widget that will display some text

        /* Some code that change the mappings */

        legend.draw(); // Redraw the widgets based on the new mappings
        return legend;
    }

</script>


</body>
</html>